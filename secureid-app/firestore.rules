rules_version = '2';

/**
 * FIRESTORE SECURITY RULES - SecureID
 * Mis à jour: Phase 3A - Support collection profiles
 *
 * Ces règles sécurisent l'accès aux données dans Firestore.
 * CRITIQUE: Ne jamais exposer les secretToken côté client!
 *
 * Documentation: https://firebase.google.com/docs/firestore/security/rules-structure
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // FONCTIONS UTILITAIRES
    // ============================================================================

    // Vérifie si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    // Vérifie si l'utilisateur est le propriétaire de la ressource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Vérifie si l'utilisateur est admin (à implémenter selon votre logique)
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ============================================================================
    // COLLECTION: bracelets
    // ============================================================================

    match /bracelets/{braceletId} {

      // LECTURE: Publique pour scan QR Code (Phase 5 - Mode Urgence)
      // IMPORTANT: Ne JAMAIS exposer secretToken côté client dans les requêtes
      allow read: if true;

      // CRÉATION: INTERDITE côté client
      // Les bracelets sont créés uniquement via le script de provisioning (Admin SDK)
      allow create: if false;

      // MISE À JOUR: Seulement certains champs et seulement par le propriétaire
      allow update: if isAuthenticated() &&
                       (resource.data.linkedUserId == request.auth.uid ||
                        // Ou via linkedProfileId
                        exists(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)) &&
                        get(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)).data.parentId == request.auth.uid) &&
                       // Empêcher la modification des champs critiques
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'secretToken', 'batchId', 'createdAt']);

      // SUPPRESSION: Seulement par admin
      allow delete: if isAdmin();
    }

    // ============================================================================
    // COLLECTION: users
    // ============================================================================

    match /users/{userId} {

      // LECTURE: L'utilisateur peut lire ses propres données
      allow read: if isOwner(userId) || isAdmin();

      // CRÉATION: Seulement lors de la première connexion (auto-création)
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['uid', 'phoneNumber', 'generatedEmail', 'createdAt']) &&
                       request.resource.data.createdAt == request.time;

      // MISE À JOUR: L'utilisateur peut modifier ses propres données
      allow update: if isOwner(userId) &&
                       // Empêcher la modification des champs critiques
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['uid', 'phoneNumber', 'generatedEmail', 'createdAt']);

      // SUPPRESSION: Seulement par admin
      allow delete: if isAdmin();

      // Sous-collection: bracelets liés
      match /linkedBracelets/{braceletId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // ============================================================================
    // COLLECTION: profiles (Phase 3 - Profils enfants)
    // ============================================================================

    match /profiles/{profileId} {

      // LECTURE: Publique pour affichage mode urgence (Phase 5)
      // Les informations sont visibles aux secouristes
      allow read: if true;

      // CRÉATION: Seulement par le parent authentifié
      allow create: if isAuthenticated() &&
                       request.resource.data.parentId == request.auth.uid &&
                       // Vérifier que les champs obligatoires sont présents
                       request.resource.data.keys().hasAll([
                         'id',
                         'parentId',
                         'fullName',
                         'medicalInfo',
                         'doctorPin',
                         'emergencyContacts',
                         'status',
                         'createdAt',
                         'updatedAt'
                       ]) &&
                       // Vérifier que seuls les champs autorisés sont présents
                       request.resource.data.keys().hasOnly([
                         'id',
                         'parentId',
                         'fullName',
                         'dateOfBirth',
                         'photoUrl',
                         'medicalInfo',
                         'doctorPin',
                         'emergencyContacts',
                         'currentBraceletId',
                         'status',
                         'createdAt',
                         'updatedAt'
                       ]) &&
                       // Valider le statut
                       request.resource.data.status in ['ACTIVE', 'ARCHIVED'] &&
                       // Valider le PIN (4 chiffres)
                       request.resource.data.doctorPin.matches('^[0-9]{4}$') &&
                       // Vérifier qu'il y a au moins 1 contact d'urgence
                       request.resource.data.emergencyContacts.size() >= 1 &&
                       request.resource.data.emergencyContacts.size() <= 5;

      // MISE À JOUR: Seulement par le parent propriétaire
      allow update: if isAuthenticated() &&
                       resource.data.parentId == request.auth.uid &&
                       request.resource.data.parentId == request.auth.uid &&
                       // Empêcher la modification de l'ID et du parentId
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'parentId', 'createdAt']);

      // SUPPRESSION: Archivage seulement (pas de vraie suppression)
      // On change le statut à ARCHIVED au lieu de supprimer
      allow delete: if false;

      // SOUS-COLLECTION: pickups (Phase 8 - Récupérateurs école)
      match /pickups/{pickupId} {
        // LECTURE: Publique pour affichage dans portail école
        allow read: if true;

        // CRÉATION: Seulement par le parent propriétaire du profil
        allow create: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid &&
                         // Vérifier les champs obligatoires
                         request.resource.data.keys().hasAll([
                           'name',
                           'relation',
                           'photoUrl',
                           'type',
                           'createdAt'
                         ]) &&
                         // Vérifier le type
                         request.resource.data.type in ['PERMANENT', 'TEMPORARY'] &&
                         // Si TEMPORARY, expiresAt doit être présent
                         (request.resource.data.type == 'PERMANENT' ||
                          (request.resource.data.type == 'TEMPORARY' && 'expiresAt' in request.resource.data.keys()));

        // MISE À JOUR: Interdite (supprimer et recréer si besoin)
        allow update: if false;

        // SUPPRESSION: Seulement par le parent propriétaire
        allow delete: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid;
      }
    }

    // ============================================================================
    // COLLECTION: admins (liste des administrateurs)
    // ============================================================================

    match /admins/{adminId} {
      // Lecture seulement par les admins
      allow read: if isAdmin();

      // Pas de création/modification/suppression via client
      allow write: if false;
    }

    // ============================================================================
    // COLLECTION: activationLogs (logs d'activation de bracelets)
    // ============================================================================

    match /activationLogs/{logId} {
      // Lecture par admin uniquement
      allow read: if isAdmin();

      // Création automatique lors de l'activation (via Cloud Function)
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll([
                         'braceletId',
                         'userId',
                         'timestamp',
                         'ipAddress'
                       ]);

      // Pas de modification ni suppression
      allow update, delete: if false;
    }

    // ============================================================================
    // COLLECTION: scans (Phase 5 - Tracking GPS)
    // ============================================================================

    match /scans/{scanId} {
      // CRÉATION: Publique pour enregistrement par secouristes
      // Validation stricte de la structure des données
      allow create: if request.resource.data.keys().hasAll([
                         'braceletId',
                         'timestamp',
                         'lat',
                         'lng',
                         'userAgent'
                       ]) &&
                       request.resource.data.braceletId is string &&
                       (request.resource.data.lat == null || request.resource.data.lat is number) &&
                       (request.resource.data.lng == null || request.resource.data.lng is number) &&
                       request.resource.data.userAgent is string;

      // LECTURE: Réservée aux parents (via bracelet lié au profile)
      allow read: if isAuthenticated();

      // MISE À JOUR: Permettre aux parents de marquer les scans comme lus
      // Uniquement pour le champ isRead
      allow update: if isAuthenticated() &&
                       // Vérifier que seul le champ isRead est modifié
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']) &&
                       // Vérifier que isRead est un booléen
                       request.resource.data.isRead is bool;

      // SUPPRESSION: Interdite
      allow delete: if false;
    }

    // ============================================================================
    // PAR DÉFAUT: TOUT EST INTERDIT
    // ============================================================================

    // Toute autre collection non listée est inaccessible
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
