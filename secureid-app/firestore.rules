rules_version = '2';

/**
 * SecureID - Règles de sécurité Firestore
 *
 * Architecture de sécurité appliquée:
 * - Principe du moindre privilège: tout est interdit par défaut
 * - Validation stricte des données à chaque écriture
 * - Séparation des rôles: parent, secouriste, admin
 * - Protection des champs sensibles (secretToken, PIN)
 *
 * Collections protégées:
 * - bracelets: Gérés uniquement via Admin SDK (pas d'accès client direct)
 * - profiles: Lecture/écriture par le parent propriétaire uniquement
 * - scans: Création publique (urgence), lecture parent seulement
 * - users: Données utilisateur privées
 *
 * IMPORTANT: secretToken ne doit JAMAIS être exposé côté client
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // FONCTIONS UTILITAIRES
    // ============================================================================

    // Vérifie si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    // Vérifie si l'utilisateur est le propriétaire de la ressource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Vérifie si l'utilisateur est admin (à implémenter selon votre logique)
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ============================================================================
    // COLLECTION: bracelets
    // ============================================================================

    match /bracelets/{braceletId} {

      // LECTURE: Seulement par le propriétaire OU via Server Actions
      // ⚠️ SÉCURITÉ CRITIQUE:
      // - secretToken ne doit JAMAIS être accessible côté client
      // - Seules les Server Actions peuvent lire les bracelets
      // - Pour mode urgence: utiliser emergency-actions.ts qui filtre secretToken
      allow read: if isAuthenticated() &&
                     (resource.data.linkedUserId == request.auth.uid ||
                      // Ou via linkedProfileId
                      exists(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)) &&
                      get(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)).data.parentId == request.auth.uid);

      // CRÉATION: INTERDITE côté client
      // Les bracelets sont créés uniquement via le script de provisioning (Admin SDK)
      allow create: if false;

      // MISE À JOUR: Seulement certains champs et seulement par le propriétaire
      allow update: if isAuthenticated() &&
                       (resource.data.linkedUserId == request.auth.uid ||
                        // Ou via linkedProfileId
                        exists(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)) &&
                        get(/databases/$(database)/documents/profiles/$(resource.data.linkedProfileId)).data.parentId == request.auth.uid) &&
                       // Empêcher la modification des champs critiques
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'secretToken', 'batchId', 'createdAt']);

      // SUPPRESSION: Seulement par admin
      allow delete: if isAdmin();
    }

    // ============================================================================
    // COLLECTION: users
    // ============================================================================

    match /users/{userId} {

      // LECTURE: L'utilisateur peut lire ses propres données
      allow read: if isOwner(userId) || isAdmin();

      // CRÉATION: Seulement lors de la première connexion (auto-création)
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['uid', 'phoneNumber', 'generatedEmail', 'createdAt']) &&
                       request.resource.data.createdAt == request.time;

      // MISE À JOUR: L'utilisateur peut modifier ses propres données
      allow update: if isOwner(userId) &&
                       // Empêcher la modification des champs critiques
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['uid', 'phoneNumber', 'generatedEmail', 'createdAt']);

      // SUPPRESSION: Seulement par admin
      allow delete: if isAdmin();

      // Sous-collection: bracelets liés
      match /linkedBracelets/{braceletId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // ============================================================================
    // COLLECTION: profiles (Phase 3 - Profils enfants)
    // ============================================================================

    match /profiles/{profileId} {

      // LECTURE: Seulement par le parent propriétaire
      // ⚠️ SÉCURITÉ CRITIQUE:
      // - doctorPin ne doit JAMAIS être accessible publiquement
      // - Mode urgence: utiliser emergency-actions.ts qui filtre doctorPin
      allow read: if isAuthenticated() &&
                     resource.data.parentId == request.auth.uid;

      // CRÉATION: Seulement par le parent authentifié
      allow create: if isAuthenticated() &&
                       request.resource.data.parentId == request.auth.uid &&
                       // Vérifier que les champs obligatoires sont présents
                       request.resource.data.keys().hasAll([
                         'id',
                         'parentId',
                         'fullName',
                         'medicalInfo',
                         'doctorPin',
                         'emergencyContacts',
                         'status',
                         'createdAt',
                         'updatedAt'
                       ]) &&
                       // Vérifier que seuls les champs autorisés sont présents
                       request.resource.data.keys().hasOnly([
                         'id',
                         'parentId',
                         'fullName',
                         'dateOfBirth',
                         'photoUrl',
                         'medicalInfo',
                         'doctorPin',
                         'emergencyContacts',
                         'currentBraceletId',
                         'status',
                         'createdAt',
                         'updatedAt'
                       ]) &&
                       // Valider le statut
                       request.resource.data.status in ['ACTIVE', 'ARCHIVED'] &&
                       // Valider le PIN (4 chiffres)
                       request.resource.data.doctorPin.matches('^[0-9]{4}$') &&
                       // Vérifier qu'il y a au moins 1 contact d'urgence
                       request.resource.data.emergencyContacts.size() >= 1 &&
                       request.resource.data.emergencyContacts.size() <= 5;

      // MISE À JOUR: Seulement par le parent propriétaire
      allow update: if isAuthenticated() &&
                       resource.data.parentId == request.auth.uid &&
                       request.resource.data.parentId == request.auth.uid &&
                       // Empêcher la modification de l'ID et du parentId
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'parentId', 'createdAt']) &&
                       // Valider le PIN si modifié (4 chiffres)
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['doctorPin']) ||
                        request.resource.data.doctorPin.matches('^[0-9]{4}$'));

      // SUPPRESSION: Archivage seulement (pas de vraie suppression)
      // On change le statut à ARCHIVED au lieu de supprimer
      allow delete: if false;

      // SOUS-COLLECTION: pickups (Phase 8 - Récupérateurs école)
      match /pickups/{pickupId} {
        // LECTURE: Publique pour affichage dans portail école
        allow read: if true;

        // CRÉATION: Seulement par le parent propriétaire du profil
        allow create: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid &&
                         // Vérifier les champs obligatoires
                         request.resource.data.keys().hasAll([
                           'name',
                           'relation',
                           'photoUrl',
                           'type',
                           'createdAt'
                         ]) &&
                         // Vérifier le type
                         request.resource.data.type in ['PERMANENT', 'TEMPORARY'] &&
                         // Si TEMPORARY, expiresAt doit être présent
                         (request.resource.data.type == 'PERMANENT' ||
                          (request.resource.data.type == 'TEMPORARY' && 'expiresAt' in request.resource.data.keys()));

        // MISE À JOUR: Interdite (supprimer et recréer si besoin)
        allow update: if false;

        // SUPPRESSION: Seulement par le parent propriétaire
        allow delete: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid;
      }

      // SOUS-COLLECTION: safeZones (Zones de sécurité GPS)
      match /safeZones/{zoneId} {
        // Fonction de validation des données de zone
        function isValidSafeZoneData() {
          let data = request.resource.data;
          return data.keys().hasAll(['name', 'icon', 'center', 'radius', 'color', 'enabled', 'alertDelay', 'profileId', 'createdAt', 'updatedAt']) &&
                 data.name is string &&
                 data.name.size() >= 2 &&
                 data.name.size() <= 50 &&
                 data.icon is string &&
                 data.center is map &&
                 data.center.keys().hasAll(['lat', 'lng']) &&
                 data.center.lat is number &&
                 data.center.lat >= -90 && data.center.lat <= 90 &&
                 data.center.lng is number &&
                 data.center.lng >= -180 && data.center.lng <= 180 &&
                 data.radius is number &&
                 data.radius >= 100 && data.radius <= 5000 &&
                 data.color is string &&
                 data.color.matches('^#[0-9A-Fa-f]{6}$') &&
                 data.enabled is bool &&
                 data.alertDelay is number &&
                 data.alertDelay >= 1 && data.alertDelay <= 60 &&
                 data.profileId == profileId;
        }

        // Fonction de validation des mises à jour
        function isValidSafeZoneUpdate() {
          let data = request.resource.data;
          let existing = resource.data;
          return data.updatedAt is timestamp &&
                 data.updatedAt > existing.updatedAt &&
                 data.createdAt == existing.createdAt &&
                 data.profileId == existing.profileId;
        }

        // LECTURE: Seulement par le parent propriétaire du profil
        allow read: if isAuthenticated() &&
                       get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid;

        // CRÉATION: Seulement par le parent avec validation complète
        allow create: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid &&
                         isValidSafeZoneData() &&
                         request.resource.data.createdAt == request.resource.data.updatedAt;

        // MISE À JOUR: Seulement par le parent avec validation
        allow update: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid &&
                         isValidSafeZoneData() &&
                         isValidSafeZoneUpdate();

        // SUPPRESSION: Seulement par le parent propriétaire
        allow delete: if isAuthenticated() &&
                         get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == request.auth.uid;
      }
    }

    // ============================================================================
    // COLLECTION: admins (liste des administrateurs)
    // ============================================================================

    match /admins/{adminId} {
      // Lecture seulement par les admins
      allow read: if isAdmin();

      // Pas de création/modification/suppression via client
      allow write: if false;
    }

    // ============================================================================
    // COLLECTION: activationLogs (logs d'activation de bracelets)
    // ============================================================================

    match /activationLogs/{logId} {
      // Lecture par admin uniquement
      allow read: if isAdmin();

      // Création automatique lors de l'activation (via Cloud Function)
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll([
                         'braceletId',
                         'userId',
                         'timestamp',
                         'ipAddress'
                       ]);

      // Pas de modification ni suppression
      allow update, delete: if false;
    }

    // ============================================================================
    // COLLECTION: scans - Historique des scans de bracelets
    // ============================================================================
    //
    // JUSTIFICATION SÉCURITÉ - Création publique:
    // Un secouriste qui trouve un enfant perdu n'est PAS authentifié.
    // Il scanne le QR code et la géolocalisation est enregistrée pour que
    // le parent puisse localiser son enfant. C'est le cœur du système d'urgence.
    //
    // PROTECTIONS EN PLACE:
    // 1. Validation stricte de la structure des données
    // 2. Types vérifiés (string, number, null autorisés)
    // 3. Rate limiting au niveau middleware (5 req/min par IP)
    // 4. Lecture réservée aux parents propriétaires du bracelet
    // ============================================================================

    match /scans/{scanId} {
      // Création publique avec validation stricte de la structure
      allow create: if request.resource.data.keys().hasAll([
                         'braceletId',
                         'timestamp',
                         'lat',
                         'lng',
                         'userAgent'
                       ]) &&
                       request.resource.data.braceletId is string &&
                       (request.resource.data.lat == null || request.resource.data.lat is number) &&
                       (request.resource.data.lng == null || request.resource.data.lng is number) &&
                       request.resource.data.userAgent is string;

      // LECTURE: Réservée aux parents des bracelets scannés
      // ⚠️ SÉCURITÉ: Vérifier que le scan concerne un bracelet du parent
      allow read: if isAuthenticated() &&
                     // Vérifier que le bracelet scanné appartient au parent
                     exists(/databases/$(database)/documents/bracelets/$(resource.data.braceletId)) &&
                     (get(/databases/$(database)/documents/bracelets/$(resource.data.braceletId)).data.linkedUserId == request.auth.uid ||
                      // Ou via linkedProfileId
                      (exists(/databases/$(database)/documents/profiles/$(get(/databases/$(database)/documents/bracelets/$(resource.data.braceletId)).data.linkedProfileId)) &&
                       get(/databases/$(database)/documents/profiles/$(get(/databases/$(database)/documents/bracelets/$(resource.data.braceletId)).data.linkedProfileId)).data.parentId == request.auth.uid));

      // MISE À JOUR: Permettre aux parents de marquer les scans comme lus
      // Uniquement pour le champ isRead
      allow update: if isAuthenticated() &&
                       // Vérifier que seul le champ isRead est modifié
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']) &&
                       // Vérifier que isRead est un booléen
                       request.resource.data.isRead is bool;

      // SUPPRESSION: Interdite
      allow delete: if false;
    }

    // ============================================================================
    // PAR DÉFAUT: TOUT EST INTERDIT
    // ============================================================================

    // Toute autre collection non listée est inaccessible
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
