rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Règle pour les photos de profils
    match /profiles/{profileId}/{fileName} {
      // Permettre la lecture à tous (pour afficher les photos sur les bracelets scannés)
      allow read: if true;

      // Permettre l'écriture uniquement aux utilisateurs authentifiés
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10MB
                   && request.resource.contentType.matches('image/.*');  // Seulement des images
    }

    // PHASE 4C - Règles pour les documents médicaux confidentiels
    match /medical_docs/{profileId}/{fileName} {
      // Helper function pour vérifier ownership du profil
      function isProfileOwner() {
        let profile = firestore.get(/databases/(default)/documents/profiles/$(profileId));
        return request.auth != null && profile.data.parentId == request.auth.uid;
      }

      // Lecture/Écriture uniquement pour le parent propriétaire
      allow read, write: if isProfileOwner()
                         && request.resource.size < 10 * 1024 * 1024  // Max 10MB
                         && (request.resource.contentType.matches('image/.*')
                             || request.resource.contentType == 'application/pdf');  // Images ou PDF

      // Suppression autorisée pour le propriétaire
      allow delete: if isProfileOwner();
    }

    // Bloquer tout accès par défaut
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
