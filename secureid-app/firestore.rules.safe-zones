// ============================================
// FIRESTORE SECURITY RULES - SAFE ZONES
// ============================================
//
// R√®gles de s√©curit√© pour la collection safeZones
// √Ä int√©grer dans firestore.rules principal
//
// Structure: profiles/{profileId}/safeZones/{zoneId}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ================================================
    // FONCTIONS HELPER
    // ================================================

    // V√©rifier si l'utilisateur est authentifi√©
    function isSignedIn() {
      return request.auth != null;
    }

    // R√©cup√©rer l'ID utilisateur authentifi√©
    function userId() {
      return request.auth.uid;
    }

    // V√©rifier si l'utilisateur est le parent du profil
    function isParentOfProfile(profileId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/profiles/$(profileId)) &&
             get(/databases/$(database)/documents/profiles/$(profileId)).data.parentId == userId();
    }

    // V√©rifier que les donn√©es de la zone sont valides
    function isValidSafeZone() {
      let data = request.resource.data;

      return data.keys().hasAll(['name', 'icon', 'center', 'radius', 'color', 'enabled', 'alertDelay', 'profileId', 'createdAt', 'updatedAt']) &&
             data.name is string &&
             data.name.size() >= 2 &&
             data.name.size() <= 50 &&
             data.icon is string &&
             data.icon.size() > 0 &&
             data.center is map &&
             data.center.keys().hasAll(['lat', 'lng']) &&
             data.center.lat is number &&
             data.center.lat >= -90 &&
             data.center.lat <= 90 &&
             data.center.lng is number &&
             data.center.lng >= -180 &&
             data.center.lng <= 180 &&
             data.radius is number &&
             data.radius >= 100 &&
             data.radius <= 5000 &&
             data.color is string &&
             data.color.matches('^#[0-9A-Fa-f]{6}$') &&
             data.enabled is bool &&
             data.alertDelay is number &&
             data.alertDelay >= 1 &&
             data.alertDelay <= 60 &&
             data.profileId is string &&
             data.profileId == profileId &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp;
    }

    // V√©rifier que la mise √† jour est valide (updatedAt modifi√©)
    function isValidUpdate() {
      let data = request.resource.data;
      let existingData = resource.data;

      // updatedAt doit √™tre modifi√©
      return data.updatedAt is timestamp &&
             data.updatedAt > existingData.updatedAt &&
             // createdAt ne doit pas changer
             data.createdAt == existingData.createdAt &&
             // profileId ne doit pas changer
             data.profileId == existingData.profileId;
    }

    // ================================================
    // R√àGLES SAFE ZONES
    // ================================================

    match /profiles/{profileId}/safeZones/{zoneId} {

      // LECTURE (GET, LIST)
      // Autoris√© si l'utilisateur est le parent du profil
      allow read: if isParentOfProfile(profileId);

      // CR√âATION (CREATE)
      // Autoris√© si:
      // - L'utilisateur est le parent du profil
      // - Les donn√©es sont valides
      // - createdAt et updatedAt sont √©gaux (nouveau document)
      allow create: if isParentOfProfile(profileId) &&
                       isValidSafeZone() &&
                       request.resource.data.createdAt == request.resource.data.updatedAt;

      // MISE √Ä JOUR (UPDATE)
      // Autoris√© si:
      // - L'utilisateur est le parent du profil
      // - Les donn√©es sont valides
      // - La mise √† jour est valide (timestamps corrects)
      allow update: if isParentOfProfile(profileId) &&
                       isValidSafeZone() &&
                       isValidUpdate();

      // SUPPRESSION (DELETE)
      // Autoris√© si l'utilisateur est le parent du profil
      allow delete: if isParentOfProfile(profileId);
    }

    // ================================================
    // REQU√äTES COLLECTION GROUP (optionnel)
    // ================================================

    // Si vous utilisez collectionGroup('safeZones')
    match /{path=**}/safeZones/{zoneId} {
      // Lecture autoris√©e si l'utilisateur est parent du profil parent
      allow read: if isSignedIn() &&
                     exists(/databases/$(database)/documents/profiles/$(resource.data.profileId)) &&
                     get(/databases/$(database)/documents/profiles/$(resource.data.profileId)).data.parentId == userId();
    }
  }
}

// ================================================
// EXEMPLES D'UTILISATION
// ================================================

// ‚úÖ AUTORIS√â:
// - Parent lit les zones de son enfant
// - Parent cr√©e une nouvelle zone pour son enfant
// - Parent modifie une zone existante de son enfant
// - Parent supprime une zone de son enfant
// - Parent toggle enabled/disabled d'une zone

// ‚ùå REFUS√â:
// - Utilisateur non authentifi√© lit les zones
// - Utilisateur A lit les zones de l'enfant de l'utilisateur B
// - Parent cr√©e zone avec nom < 2 caract√®res
// - Parent cr√©e zone avec radius > 5000m
// - Parent cr√©e zone avec alertDelay > 60 minutes
// - Parent modifie profileId d'une zone existante
// - Parent modifie createdAt d'une zone existante

// ================================================
// TESTS RECOMMAND√âS
// ================================================

/*
// Test 1: Lecture autoris√©e pour parent
let parentId = "user123";
let profileId = "profile456";
let zoneId = "zone789";

// Setup: Profil existe avec parentId = user123
// Result: ‚úÖ Parent peut lire la zone

// Test 2: Lecture refus√©e pour non-parent
let otherUserId = "user999";
// Result: ‚ùå Utilisateur 999 ne peut pas lire la zone du profil 456

// Test 3: Cr√©ation avec donn√©es valides
let validZone = {
  name: "√âcole Primaire",
  icon: "üè´",
  center: { lat: 12.3714, lng: -1.5197 },
  radius: 500,
  color: "#22c55e",
  enabled: true,
  alertDelay: 5,
  profileId: "profile456",
  createdAt: timestamp.now(),
  updatedAt: timestamp.now()
};
// Result: ‚úÖ Cr√©ation r√©ussie

// Test 4: Cr√©ation avec radius invalide
let invalidZone = { ...validZone, radius: 10000 };
// Result: ‚ùå Refus√© (radius > 5000)

// Test 5: Mise √† jour valid
let updateData = {
  ...validZone,
  name: "√âcole Nouvelle",
  updatedAt: timestamp.now() + 1000
};
// Result: ‚úÖ Mise √† jour r√©ussie

// Test 6: Tentative modification profileId
let invalidUpdate = {
  ...validZone,
  profileId: "profile999",
  updatedAt: timestamp.now() + 1000
};
// Result: ‚ùå Refus√© (profileId ne peut pas changer)
*/

// ================================================
// INT√âGRATION DANS firestore.rules PRINCIPAL
// ================================================

/*
Pour int√©grer ces r√®gles dans votre fichier firestore.rules principal:

1. Ouvrir firestore.rules √† la racine du projet
2. Copier les fonctions helper en haut
3. Copier les r√®gles safeZones dans le bloc "match /databases/{database}/documents"
4. D√©ployer avec: firebase deploy --only firestore:rules
5. Tester dans Firebase Console > Firestore > Rules

Exemple fichier final:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Fonctions helper (copier depuis ci-dessus)
    function isSignedIn() { ... }
    function isParentOfProfile(profileId) { ... }
    function isValidSafeZone() { ... }
    function isValidUpdate() { ... }

    // R√®gles profiles (existantes)
    match /profiles/{profileId} {
      // Vos r√®gles existantes
    }

    // R√®gles safeZones (nouvelles - copier depuis ci-dessus)
    match /profiles/{profileId}/safeZones/{zoneId} {
      allow read: if isParentOfProfile(profileId);
      allow create: if ...
      allow update: if ...
      allow delete: if ...
    }

    // Autres collections...
  }
}
*/

// ================================================
// INDEX COMPOSITES RECOMMAND√âS
// ================================================

/*
Firebase cr√©era automatiquement les index simples.
Aucun index composite n'est n√©cessaire pour les requ√™tes actuelles:

- getSafeZones: query par profileId + orderBy createdAt
  ‚Üí Index automatique cr√©√© par Firebase

Si vous ajoutez des requ√™tes complexes plus tard:

firestore.indexes.json:
{
  "indexes": [
    {
      "collectionGroup": "safeZones",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "profileId", "order": "ASCENDING" },
        { "fieldPath": "enabled", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}

D√©ployer: firebase deploy --only firestore:indexes
*/
